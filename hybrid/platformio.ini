; ═══════════════════════════════════════════════════════════════════
; AETHER Pulse Firmware - PlatformIO Configuration
; ═══════════════════════════════════════════════════════════════════
;
; Two firmware variants from shared codebase:
;   - pulse_hybrid:  WiFi sACN/E1.31 + UDP JSON (stable, deployed)
;   - pulse_espnow:  ESP-NOW broadcast transport (beta)
;
; Build commands:
;   pio run -e pulse_hybrid         # Build hybrid firmware
;   pio run -e pulse_espnow         # Build ESP-NOW firmware
;   pio run -e pulse_hybrid -t upload
;   pio run -e pulse_espnow -t upload
;
; OTA channels:
;   pulse_hybrid -> stable-hybrid (won't accept espnow firmware)
;   pulse_espnow -> beta-espnow   (won't accept hybrid firmware)
;
; ═══════════════════════════════════════════════════════════════════

[platformio]
default_envs = pulse_hybrid
src_dir = src
include_dir = include

; ═══════════════════════════════════════════════════════════════════
; COMMON SETTINGS (shared by all environments)
; ═══════════════════════════════════════════════════════════════════
[env]
platform = espressif32@6.4.0
board = esp32dev
framework = arduino
monitor_speed = 115200
upload_speed = 921600

; Common libraries
lib_deps =
    someweisguy/esp_dmx@^4.1.0
    bblanchon/ArduinoJson@^7.0.0
    adafruit/Adafruit SSD1306@^2.5.9
    adafruit/Adafruit GFX Library@^1.11.9

; Common build flags
build_flags =
    -DCORE_DEBUG_LEVEL=0
    -DAETHER_FIRMWARE_VERSION_MAJOR=1
    -DAETHER_FIRMWARE_VERSION_MINOR=3
    -DAETHER_FIRMWARE_VERSION_PATCH=0
    -DAETHER_PROTOCOL_VERSION=1

; ═══════════════════════════════════════════════════════════════════
; PULSE HYBRID (Stable - sACN/E1.31 + UDP JSON)
; ═══════════════════════════════════════════════════════════════════
; Transport: WiFi multicast sACN for DMX frames, UDP JSON for commands
; Fade model: Node-side interpolation via UDP JSON "fade" parameter
; OTA channel: stable-hybrid
; ═══════════════════════════════════════════════════════════════════
[env:pulse_hybrid]
lib_deps =
    ${env.lib_deps}
    forkineye/ESPAsyncE131@^1.0.3

build_flags =
    ${env.build_flags}
    -DPULSE_FAMILY_HYBRID=1
    -DAETHER_FIRMWARE_FAMILY=\"pulse-hybrid\"
    -DAETHER_OTA_CHANNEL=\"stable-hybrid\"
    -DENABLE_SACN=1
    -DENABLE_UDP_JSON=1

; ═══════════════════════════════════════════════════════════════════
; PULSE ESP-NOW (Beta - ESP-NOW broadcast transport)
; ═══════════════════════════════════════════════════════════════════
; Transport: ESP-NOW broadcast (no WiFi infrastructure needed)
; Fade model: Node-side interpolation (fade_ms in packet)
; OTA channel: beta-espnow
; Requires: One ESP32 as Gateway (connected to Pi via UART)
; ═══════════════════════════════════════════════════════════════════
[env:pulse_espnow]
build_flags =
    ${env.build_flags}
    -DPULSE_FAMILY_ESPNOW=1
    -DAETHER_FIRMWARE_FAMILY=\"pulse-espnow\"
    -DAETHER_OTA_CHANNEL=\"beta-espnow\"
    -DENABLE_ESPNOW=1
    -DESPNOW_CHANNEL=6

; ═══════════════════════════════════════════════════════════════════
; PULSE HYBRID + ESPNOW GATEWAY (Dual-mode - sACN in + ESP-NOW out)
; ═══════════════════════════════════════════════════════════════════
; Transport: Receives via WiFi sACN/E1.31, ALSO rebroadcasts via ESP-NOW
; Use case: Pi-connected ESP that bridges sACN to ESP-NOW nodes
; This allows mixed deployment:
;   - Older nodes: receive sACN directly from Pi
;   - Newer nodes: receive ESP-NOW from gateway
; OTA channel: stable-hybrid (same as pulse_hybrid)
; ═══════════════════════════════════════════════════════════════════
[env:pulse_hybrid_gateway]
lib_deps =
    ${env.lib_deps}
    forkineye/ESPAsyncE131@^1.0.3

build_flags =
    ${env.build_flags}
    -DPULSE_FAMILY_HYBRID=1
    -DAETHER_FIRMWARE_FAMILY=\"pulse-hybrid-gateway\"
    -DAETHER_OTA_CHANNEL=\"stable-hybrid\"
    -DENABLE_SACN=1
    -DENABLE_UDP_JSON=1
    -DENABLE_ESPNOW_GATEWAY=1
    -DESPNOW_CHANNEL=6

; ═══════════════════════════════════════════════════════════════════
; PULSE WIRED GATEWAY (UART in + ESP-NOW out) - RECOMMENDED FOR PI
; ═══════════════════════════════════════════════════════════════════
; Transport: Receives DMX via UART from Pi, rebroadcasts via ESP-NOW
; Use case: Pi-connected Master ESP that bridges to all ESP-NOW nodes
; Benefits over sACN gateway:
;   - Lower latency (no WiFi stack for receiving)
;   - More reliable (no packet loss from WiFi congestion)
;   - Smoother DMX output (consistent timing from UART)
;   - Master ESP doesn't need WiFi AP connection
; OTA channel: stable-hybrid (can still be updated via WiFi if needed)
; ═══════════════════════════════════════════════════════════════════
[env:pulse_wired_gateway]
lib_deps =
    ${env.lib_deps}

build_flags =
    ${env.build_flags}
    -DPULSE_FAMILY_HYBRID=1
    -DAETHER_FIRMWARE_FAMILY=\"pulse-wired-gateway\"
    -DAETHER_OTA_CHANNEL=\"stable-hybrid\"
    -DENABLE_ESPNOW_GATEWAY=1
    -DESPNOW_CHANNEL=6

; ═══════════════════════════════════════════════════════════════════
; DEBUG VARIANTS
; ═══════════════════════════════════════════════════════════════════
[env:pulse_hybrid_debug]
extends = env:pulse_hybrid
build_flags =
    ${env:pulse_hybrid.build_flags}
    -DCORE_DEBUG_LEVEL=3
    -DDEBUG_VERBOSE=1

[env:pulse_espnow_debug]
extends = env:pulse_espnow
build_flags =
    ${env:pulse_espnow.build_flags}
    -DCORE_DEBUG_LEVEL=3
    -DDEBUG_VERBOSE=1
